<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Appendix: A parsing strategy | CommonMark Spec</title>
    <meta name="description" content="">
    <link rel="icon" href="/commonmark-vuepress/logo.png">
    
    <link rel="preload" href="/commonmark-vuepress/assets/css/0.styles.a10e70b6.css" as="style"><link rel="preload" href="/commonmark-vuepress/assets/js/app.66e8c4d4.js" as="script"><link rel="preload" href="/commonmark-vuepress/assets/js/10.c4ec4b3d.js" as="script"><link rel="prefetch" href="/commonmark-vuepress/assets/js/5.56fac433.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/2.cda51ec0.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/3.0f7c7ffe.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/4.b69c7f9c.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/6.11117854.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/7.accca9e3.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/8.64a5eca8.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/9.9a3e5730.js"><link rel="prefetch" href="/commonmark-vuepress/assets/js/11.d4500ffb.js">
    <link rel="stylesheet" href="/commonmark-vuepress/assets/css/0.styles.a10e70b6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/commonmark-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">CommonMark Spec</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://spec.commonmark.org/0.28/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Original Site
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/commonmark/CommonMark" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Original Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/yangjunjun/commonmark-vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://spec.commonmark.org/0.28/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Original Site
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/commonmark/CommonMark" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Original Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/yangjunjun/commonmark-vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/commonmark-vuepress/" class="sidebar-link">0 Home</a></li><li><a href="/commonmark-vuepress/1.Introduction.html" class="sidebar-link">1 Introduction</a></li><li><a href="/commonmark-vuepress/2.Preliminaries.html" class="sidebar-link">2 Preliminaries</a></li><li><a href="/commonmark-vuepress/3.Blocks_and_inlines.html" class="sidebar-link">3 Blocks and inlines</a></li><li><a href="/commonmark-vuepress/4.Leaf_blocks.html" class="sidebar-link">4 Leaf blocks</a></li><li><a href="/commonmark-vuepress/5.Container_blocks.html" class="sidebar-link">5 Container blocks</a></li><li><a href="/commonmark-vuepress/6.Inlines.html" class="sidebar-link">6 Inlines</a></li><li><a href="/commonmark-vuepress/7.Appendix_A_parsing_strategy.html" class="active sidebar-link">Appendix: A parsing strategy</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/commonmark-vuepress/7.Appendix_A_parsing_strategy.html#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/commonmark-vuepress/7.Appendix_A_parsing_strategy.html#phase-1-block-structure" class="sidebar-link">Phase 1: block structure</a></li><li class="sidebar-sub-header"><a href="/commonmark-vuepress/7.Appendix_A_parsing_strategy.html#phase-2-inline-structure" class="sidebar-link">Phase 2: inline structure</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="appendix-a-parsing-strategy"><a href="#appendix-a-parsing-strategy" aria-hidden="true" class="header-anchor">#</a> Appendix: A parsing strategy</h1> <p>In this appendix we describe some features of the parsing strategy
used in the CommonMark reference implementations.</p> <h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2> <p>Parsing has two phases:</p> <ol><li><p>In the first phase, lines of input are consumed and the block
structure of the document---its division into paragraphs, block quotes,
list items, and so on---is constructed.  Text is assigned to these
blocks but not parsed. Link reference definitions are parsed and a
map of links is constructed.</p></li> <li><p>In the second phase, the raw text contents of paragraphs and headings
are parsed into sequences of Markdown inline elements (strings,
code spans, links, emphasis, and so on), using the map of link
references constructed in phase 1.</p></li></ol> <p>At each point in processing, the document is represented as a tree of
<strong>blocks</strong>.  The root of the tree is a <code>document</code> block.  The <code>document</code>
may have any number of other blocks as <strong>children</strong>.  These children
may, in turn, have other blocks as children.  The last child of a block
is normally considered <strong>open</strong>, meaning that subsequent lines of input
can alter its contents.  (Blocks that are not open are <strong>closed</strong>.)
Here, for example, is a possible document tree, with the open blocks
marked by arrows:</p> <div class="language-tree extra-class"><pre class="language-text"><code>-&gt; document
  -&gt; block_quote
       paragraph
         &quot;Lorem ipsum dolor\nsit amet.&quot;
    -&gt; list (type=bullet tight=true bullet_char=-)
         list_item
           paragraph
             &quot;Qui *quodsi iracundia*&quot;
      -&gt; list_item
        -&gt; paragraph
             &quot;aliquando id&quot;
</code></pre></div><h2 id="phase-1-block-structure"><a href="#phase-1-block-structure" aria-hidden="true" class="header-anchor">#</a> Phase 1: block structure</h2> <p>Each line that is processed has an effect on this tree.  The line is
analyzed and, depending on its contents, the document may be altered
in one or more of the following ways:</p> <ol><li>One or more open blocks may be closed.</li> <li>One or more new blocks may be created as children of the
last open block.</li> <li>Text may be added to the last (deepest) open block remaining
on the tree.</li></ol> <p>Once a line has been incorporated into the tree in this way,
it can be discarded, so input can be read in a stream.</p> <p>For each line, we follow this procedure:</p> <ol><li><p>First we iterate through the open blocks, starting with the
root document, and descending through last children down to the last
open block.  Each block imposes a condition that the line must satisfy
if the block is to remain open.  For example, a block quote requires a
<code>&gt;</code> character.  A paragraph requires a non-blank line.
In this phase we may match all or just some of the open
blocks.  But we cannot close unmatched blocks yet, because we may have a
[lazy continuation line].</p></li> <li><p>Next, after consuming the continuation markers for existing
blocks, we look for new block starts (e.g. <code>&gt;</code> for a block quote).
If we encounter a new block start, we close any blocks unmatched
in step 1 before creating the new block as a child of the last
matched block.</p></li> <li><p>Finally, we look at the remainder of the line (after block
markers like <code>&gt;</code>, list markers, and indentation have been consumed).
This is text that can be incorporated into the last open
block (a paragraph, code block, heading, or raw HTML).</p></li></ol> <p>Setext headings are formed when we see a line of a paragraph
that is a [setext heading underline].</p> <p>Reference link definitions are detected when a paragraph is closed;
the accumulated text lines are parsed to see if they begin with
one or more reference link definitions.  Any remainder becomes a
normal paragraph.</p> <p>We can see how this works by considering how the tree above is
generated by four lines of Markdown:</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token blockquote punctuation">&gt;</span> Lorem ipsum dolor
sit amet.
<span class="token blockquote punctuation">&gt;</span> <span class="token list punctuation">-</span> Qui <span class="token italic"><span class="token punctuation">*</span>quodsi iracundia<span class="token punctuation">*</span></span>
<span class="token blockquote punctuation">&gt;</span> <span class="token list punctuation">-</span> aliquando id
</code></pre></div><p>At the outset, our document model is just</p> <div class="language-tree extra-class"><pre class="language-text"><code>-&gt; document
</code></pre></div><p>The first line of our text,</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token blockquote punctuation">&gt;</span> Lorem ipsum dolor
</code></pre></div><p>causes a <code>block_quote</code> block to be created as a child of our
open <code>document</code> block, and a <code>paragraph</code> block as a child of
the <code>block_quote</code>.  Then the text is added to the last open
block, the <code>paragraph</code>:</p> <div class="language-tree extra-class"><pre class="language-text"><code>-&gt; document
  -&gt; block_quote
    -&gt; paragraph
         &quot;Lorem ipsum dolor&quot;
</code></pre></div><p>The next line,</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code>sit amet.
</code></pre></div><p>is a &quot;lazy continuation&quot; of the open <code>paragraph</code>, so it gets added
to the paragraph's text:</p> <div class="language-tree extra-class"><pre class="language-text"><code>-&gt; document
  -&gt; block_quote
    -&gt; paragraph
         &quot;Lorem ipsum dolor\nsit amet.&quot;
</code></pre></div><p>The third line,</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token blockquote punctuation">&gt;</span> <span class="token list punctuation">-</span> Qui <span class="token italic"><span class="token punctuation">*</span>quodsi iracundia<span class="token punctuation">*</span></span>
</code></pre></div><p>causes the <code>paragraph</code> block to be closed, and a new <code>list</code> block
opened as a child of the <code>block_quote</code>.  A <code>list_item</code> is also
added as a child of the <code>list</code>, and a <code>paragraph</code> as a child of
the <code>list_item</code>.  The text is then added to the new <code>paragraph</code>:</p> <div class="language-tree extra-class"><pre class="language-text"><code>-&gt; document
  -&gt; block_quote
       paragraph
         &quot;Lorem ipsum dolor\nsit amet.&quot;
    -&gt; list (type=bullet tight=true bullet_char=-)
      -&gt; list_item
        -&gt; paragraph
             &quot;Qui *quodsi iracundia*&quot;
</code></pre></div><p>The fourth line,</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token blockquote punctuation">&gt;</span> <span class="token list punctuation">-</span> aliquando id
</code></pre></div><p>causes the <code>list_item</code> (and its child the <code>paragraph</code>) to be closed,
and a new <code>list_item</code> opened up as child of the <code>list</code>.  A <code>paragraph</code>
is added as a child of the new <code>list_item</code>, to contain the text.
We thus obtain the final tree:</p> <div class="language-tree extra-class"><pre class="language-text"><code>-&gt; document
  -&gt; block_quote
       paragraph
         &quot;Lorem ipsum dolor\nsit amet.&quot;
    -&gt; list (type=bullet tight=true bullet_char=-)
         list_item
           paragraph
             &quot;Qui *quodsi iracundia*&quot;
      -&gt; list_item
        -&gt; paragraph
             &quot;aliquando id&quot;
</code></pre></div><h2 id="phase-2-inline-structure"><a href="#phase-2-inline-structure" aria-hidden="true" class="header-anchor">#</a> Phase 2: inline structure</h2> <p>Once all of the input has been parsed, all open blocks are closed.</p> <p>We then &quot;walk the tree,&quot; visiting every node, and parse raw
string contents of paragraphs and headings as inlines.  At this
point we have seen all the link reference definitions, so we can
resolve reference links as we go.</p> <div class="language-tree extra-class"><pre class="language-text"><code>document
  block_quote
    paragraph
      str &quot;Lorem ipsum dolor&quot;
      softbreak
      str &quot;sit amet.&quot;
    list (type=bullet tight=true bullet_char=-)
      list_item
        paragraph
          str &quot;Qui &quot;
          emph
            str &quot;quodsi iracundia&quot;
      list_item
        paragraph
          str &quot;aliquando id&quot;
</code></pre></div><p>Notice how the [line ending] in the first paragraph has
been parsed as a <code>softbreak</code>, and the asterisks in the first list item
have become an <code>emph</code>.</p> <h3 id="an-algorithm-for-parsing-nested-emphasis-and-links"><a href="#an-algorithm-for-parsing-nested-emphasis-and-links" aria-hidden="true" class="header-anchor">#</a> An algorithm for parsing nested emphasis and links</h3> <p>By far the trickiest part of inline parsing is handling emphasis,
strong emphasis, links, and images.  This is done using the following
algorithm.</p> <p>When we're parsing inlines and we hit either</p> <ul><li>a run of <code>*</code> or <code>_</code> characters, or</li> <li>a <code>[</code> or <code>![</code></li></ul> <p>we insert a text node with these symbols as its literal content, and we
add a pointer to this text node to the <a href="@">delimiter stack</a>.</p> <p>The [delimiter stack] is a doubly linked list.  Each
element contains a pointer to a text node, plus information about</p> <ul><li>the type of delimiter (<code>[</code>, <code>![</code>, <code>*</code>, <code>_</code>)</li> <li>the number of delimiters,</li> <li>whether the delimiter is &quot;active&quot; (all are active to start), and</li> <li>whether the delimiter is a potential opener, a potential closer,
or both (which depends on what sort of characters precede
and follow the delimiters).</li></ul> <p>When we hit a <code>]</code> character, we call the <em>look for link or image</em>
procedure (see below).</p> <p>When we hit the end of the input, we call the <em>process emphasis</em>
procedure (see below), with <code>stack_bottom</code> = NULL.</p> <h4 id="look-for-link-or-image"><a href="#look-for-link-or-image" aria-hidden="true" class="header-anchor">#</a> <em>look for link or image</em></h4> <p>Starting at the top of the delimiter stack, we look backwards
through the stack for an opening <code>[</code> or <code>![</code> delimiter.</p> <ul><li><p>If we don't find one, we return a literal text node <code>]</code>.</p></li> <li><p>If we do find one, but it's not <em>active</em>, we remove the inactive
delimiter from the stack, and return a literal text node <code>]</code>.</p></li> <li><p>If we find one and it's active, then we parse ahead to see if
we have an inline link/image, reference link/image, compact reference
link/image, or shortcut reference link/image.</p> <ul><li><p>If we don't, then we remove the opening delimiter from the
delimiter stack and return a literal text node <code>]</code>.</p></li> <li><p>If we do, then</p> <ul><li><p>We return a link or image node whose children are the inlines
after the text node pointed to by the opening delimiter.</p></li> <li><p>We run <em>process emphasis</em> on these inlines, with the <code>[</code> opener
as <code>stack_bottom</code>.</p></li> <li><p>We remove the opening delimiter.</p></li> <li><p>If we have a link (and not an image), we also set all
<code>[</code> delimiters before the opening delimiter to <em>inactive</em>.  (This
will prevent us from getting links within links.)</p></li></ul></li></ul></li></ul> <h4 id="process-emphasis"><a href="#process-emphasis" aria-hidden="true" class="header-anchor">#</a> <em>process emphasis</em></h4> <p>Parameter <code>stack_bottom</code> sets a lower bound to how far we
descend in the [delimiter stack].  If it is NULL, we can
go all the way to the bottom.  Otherwise, we stop before
visiting <code>stack_bottom</code>.</p> <p>Let <code>current_position</code> point to the element on the [delimiter stack]
just above <code>stack_bottom</code> (or the first element if <code>stack_bottom</code>
is NULL).</p> <p>We keep track of the <code>openers_bottom</code> for each delimiter
type (<code>*</code>, <code>_</code>).  Initialize this to <code>stack_bottom</code>.</p> <p>Then we repeat the following until we run out of potential
closers:</p> <ul><li><p>Move <code>current_position</code> forward in the delimiter stack (if needed)
until we find the first potential closer with delimiter <code>*</code> or <code>_</code>.
(This will be the potential closer closest
to the beginning of the input -- the first one in parse order.)</p></li> <li><p>Now, look back in the stack (staying above <code>stack_bottom</code> and
the <code>openers_bottom</code> for this delimiter type) for the
first matching potential opener (&quot;matching&quot; means same delimiter).</p></li> <li><p>If one is found:</p> <ul><li><p>Figure out whether we have emphasis or strong emphasis:
if both closer and opener spans have length &gt;= 2, we have
strong, otherwise regular.</p></li> <li><p>Insert an emph or strong emph node accordingly, after
the text node corresponding to the opener.</p></li> <li><p>Remove any delimiters between the opener and closer from
the delimiter stack.</p></li> <li><p>Remove 1 (for regular emph) or 2 (for strong emph) delimiters
from the opening and closing text nodes.  If they become empty
as a result, remove them and remove the corresponding element
of the delimiter stack.  If the closing node is removed, reset
<code>current_position</code> to the next element in the stack.</p></li></ul></li> <li><p>If none in found:</p> <ul><li><p>Set <code>openers_bottom</code> to the element before <code>current_position</code>.
(We know that there are no openers for this kind of closer up to and
including this point, so this puts a lower bound on future searches.)</p></li> <li><p>If the closer at <code>current_position</code> is not a potential opener,
remove it from the delimiter stack (since we know it can't
be a closer either).</p></li> <li><p>Advance <code>current_position</code> to the next element in the stack.</p></li></ul></li></ul> <p>After we're done, we remove all delimiters above <code>stack_bottom</code> from the
delimiter stack.</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/commonmark-vuepress/6.Inlines.html" class="prev">
          6 Inlines
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/commonmark-vuepress/assets/js/10.c4ec4b3d.js" defer></script><script src="/commonmark-vuepress/assets/js/app.66e8c4d4.js" defer></script>
  </body>
</html>
